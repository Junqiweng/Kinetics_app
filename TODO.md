# TODO / Roadmap

> **目标**：保持"化工工程师友好"的简单流程，同时逐步增强数值稳健性与可解释性。

---

## 维护说明

- 历史里程碑与版本记录请以 Git 提交历史/Release 为准。
- 本文档仅保留“未完成或待决策”事项，避免与当前代码状态冲突。

---

## 最近完成（2026-02-10）

- [x] 清理历史遗留文件：删除 `modules/kinetics.py.bak`
- [x] 清理仓库缓存目录：`__pycache__/`、`.pytest_cache/`
- [x] 同步文档口径：示例 CSV 为脚本产物，默认不提交到仓库
- [x] 补充并验证最小回归命令：`smoke_validate.py`、`regression_state_validate.py`

---

## 近期（高优先级）

### 数据验证与用户体验

- [ ] **CSV 数据质量检查器（首要）**：添加"数据检查"按钮，一键检查：
  - 缺失列（必需列vs实际列）
  - 非数字值/NaN/空值位置
  - 单位范围合理性（温度 > 0 K，体积 > 0 等）
  - 不启动拟合，仅生成诊断报告

- [ ] **参数输入智能提示（次优先）**：
  - 为 `k0`、`Ea`、`K0_ads` 添加"推荐数量级"提示框
  - 根据反应类型和温度范围给出典型值范围
  - 初值与边界差距过大时警告（例如 `k0_初值 < k0_下界`）

- [ ] **测量列 NaN 处理增强（次优先）**：
  - 在选择测量列时实时显示 NaN 统计
  - 提供"跳过含 NaN 行"或"拟合前插值"选项
  - 显示被跳过的行号和原因

- [ ] **文档一致性自动检查**：
  - 增加脚本检查 `README / docs / test_data/README` 的关键术语一致性
  - 检查项至少包括：PFR 两种流动模型、示例数据生成方式、回归命令

### 拟合结果可解释性

- [ ] **参数不确定度估计**：
  - 基于 Jacobian 矩阵计算参数置信区间（95% CI）
  - 显示参数相对误差（例如 `k0 = 1.23e6 ± 0.15e6`）

- [ ] **参数相关性矩阵**：
  - 计算并显示 `k0`–`Ea` 等参数对的相关系数
  - 高相关性（|r| > 0.9）时提示"参数可能不独立"

---

## 中期（功能增强）

### 拟合策略优化

- [ ] **加权残差支持**：
  - 允许用户上传 `sigma_<species>` 列（测量误差）
  - 或设置统一相对误差权重（例如 10% 相对误差）
  - 修改残差计算：`residual = (pred - exp) / sigma`

- [ ] **选择性拟合工况**：
  - UI 增加"筛选条件"：按温度范围、体积范围、时间范围筛选
  - 仅用筛选后的行进行拟合
  - 用例：排除异常工况，或分段拟合不同温度区间

- [ ] **多目标拟合支持**：
  - 同时拟合多个目标变量（例如 `Fout_A` 和 `Fout_B`）
  - 允许为不同目标设置不同权重

### 诊断与可视化

- [ ] **残差分析图**：
  - 绘制残差 vs 预测值（检查异方差性）
  - 残差 vs 温度、体积等自变量（检查系统偏差）
  - Q-Q 图（检查残差正态性）

- [ ] **敏感性分析（简化版）**：
  - 计算各参数对输出的敏感性系数（局部导数）
  - 显示哪些参数对拟合结果影响最大

---

## 长期（需明确需求或架构调整）

### 物理模型扩展

- [ ] **非等温反应器**：
  - 增加能量方程：$\frac{dT}{dV} = \frac{\sum \Delta H_j r_j}{\rho C_p \dot{v}}$
  - 需要用户提供：反应热 $\Delta H_j$、热容 $C_p$、传热系数 $U$（CSTR/BSTR）
  - 增加温度边界条件（进口温度、壁温等）

- [ ] **变密度体系**：
  - 支持体积流量沿程变化（气相反应）
  - PFR 需求：$\frac{d\dot{v}}{dV} = \dot{v}_0 \frac{T}{T_0} \sum \delta_j r_j$
  - 增加压降模型（Ergun 方程、Darcy-Weisbach 等）

- [ ] **多相反应**：
  - 气-液、气-固催化反应
  - 需要传质模型（液相膜扩散、孔内扩散）
  - 有效性因子计算

### 数值算法增强

- [ ] **全局优化器集成**：
  - 提供差分进化（`differential_evolution`）或遗传算法选项
  - 用于初值敏感的复杂模型（例如多反应、高非线性）

- [ ] **贝叶斯参数估计（高级）**：
  - 使用 MCMC（例如 `emcee`）得到参数后验分布
  - 适合小数据集或需要不确定度量化的场景

---

## 已知限制（当前代码基线）

### 反应器模型假设

- **PFR**：当前支持两种流动模型
  - 液相恒定体积流量：$C_i = F_i / \dot{v}$
  - 气相理想气体、等温恒压：$C_i = y_i P/(RT)$（$y_i = F_i/\sum F_i$）
  - 两种模式均不考虑压降与非理想气体效应

- **CSTR**：仅稳态求解，不考虑启动/瞬态过程
  - 假设完全混合，出口浓度 = 反应器内浓度

- **BSTR**：假设恒定体积（$V = \text{const}$），无进出料
  - 不适用于半连续操作

### 数据要求

- **所选测量列**必须在所有实验行中有有效数值（不允许 NaN、空值、非数字）
- 温度、体积、流量等输入列需为正数（已有边界检查）
- 不支持缺失数据的自动插值或外推

### 拟合算法

- 使用局部优化（`scipy.optimize.least_squares` + TRF）
  - 多峰目标函数可能陷入局部最优
  - 依赖初值质量（提供多起点尝试功能缓解此问题）

- 参数边界由用户手动设置
  - 不当的边界设置可能导致拟合失败或无物理意义的结果

### 数值稳定性

- 负反应级数 + 零浓度：已通过 `EPSILON_CONCENTRATION` 限幅避免 `0^(-n)`
- 刚性 ODE：提供 LSODA（默认）/ BDF / Radau / RK45 求解器选项，但不保证所有刚性系统收敛

---

## 贡献指南

如需添加新功能或修复问题，请参考：

- [AGENTS.md](AGENTS.md) - 开发与协作规范
- [docs/user_guide.md](docs/user_guide.md) - 用户文档
- [test_data/README.md](test_data/README.md) - 测试数据生成方法
