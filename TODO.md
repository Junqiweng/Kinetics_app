# TODO List - Kinetics_app

> 目标：基于当前 `app.py` 的实现，把后续工作拆成“可执行、可验证”的小任务。

## P0（优先）可用性与可靠性

- [ ] **用户配置持久化（最实用）**
  - [ ] 一键“导出当前设置”为 `json`（反应器/模型/矩阵/初值/边界/高级拟合设置）
  - [ ] 一键“导入设置”并自动填充 UI（避免每次重输）
  - [ ] 可选：启动时自动恢复上次配置（提供“重置为默认”）

- [ ] **输入数据验证更严格、报错更友好**
  - [ ] 对 CSV 必要列做“缺失/非法值”汇总提示，并给出最小修复建议（例如 `T_K>0`、`vdot_m3_s>0`）
  - [ ] 对“测量列缺测行被惩罚残差”的行为，在拟合结果区显示：缺测行数/占比
  - [ ] 当某些行 `solve_ivp` 失败时，输出失败行号与失败原因（便于定位实验点）

- [ ] **数值稳定性（面向常见坑）**
  - [ ] 负级数 + 低浓度：允许用户设置浓度下限 `C_eps`（当前硬编码为 `1e-30 mol/m³`）
  - [ ] L-H 分母项 `(1 + ΣK·C)^m`：对极端参数给出溢出/下溢警告，并建议缩放/边界调整
  - [ ] 增加“参数量纲/单位提示”：尤其是 `k0` 单位随总级数变化的提醒（避免误用）

- [ ] **性能优化（不改变算法）**
  - [ ] 在拟合前提供“抽样拟合（先用 50~200 行找初值）”选项
  - [ ] 增加缓存：同一参数向量下，避免重复对相同行进行积分（或对相同 `T_K,V/t,vdot,F0/C0` 组合做缓存）
  - [ ] 多起点拟合支持并行（可选，需注意 Windows/Streamlit 的进程限制）

## P1（增强功能）科研/工程分析能力

- [ ] **灵敏度分析（按你最关心的输出）**
  - [ ] 参数对输出的局部灵敏度：$\\partial y/\\partial \\theta$（可用有限差分）
  - [ ] 以热图/条形图展示：哪个参数对哪个物种输出最敏感
  - [ ] 与当前 `diff_step` 区分：灵敏度用于解释/诊断，`diff_step` 用于优化 Jacobian

- [ ] **参数不确定度（替代“已移除的置信区间”更稳健）**
  - [ ] Bootstrap（对实验行重采样）估计参数区间与相关性（更直观、更抗非线性）
  - [ ] 输出：参数分布图、相关性热图、预测区间（可选）

- [ ] **更合理的权重与目标函数**
  - [ ] 支持用户输入测量标准差 `sigma_*`（或全局 sigma）并用 $1/\\sigma$ 加权
  - [ ] 同时拟合多种测量类型（例如同时用 `Cout` 与 `X`）的组合目标

- [x] **结果可视化增强**
  - [x] 增加“沿程/随时间剖面”输出（PFR: $F_i(V)$ / $C_i(V)$；Batch: $C_i(t)$）
  - [x] 一键导出图（PNG/SVG）与报告表（CSV）

## P2（维护与工程化，保持“脚本式”简单）

- [ ] **拆分 `app.py`（不引入复杂架构）**
  - [ ] `reactors.py`：PFR/Batch 积分
  - [ ] `kinetics.py`：幂律 / L-H / 可逆速率
  - [ ] `fitting.py`：参数打包/解包、边界、残差函数
  - [ ] `ui_help.py`：帮助页文本与示例数据生成

- [ ] **基础测试与自检**
  - [ ] 最小单元测试：速率函数维度/符号、PFR/Batch 在简单体系下的可解析对照
  - [ ] `python -m py_compile app.py` 作为最低门槛的 CI 检查

- [ ] **仓库卫生**
  - [ ] 增加 `.gitignore`（忽略 `__pycache__/`、`.pyc`、`.streamlit/secrets.toml` 等）
  - [ ] 清理误提交的 `__pycache__/*.pyc`（如果已进入 Git 历史可另行处理）

## 🐛 已知问题（与当前实现直接相关）

- [ ] 负级数且浓度趋近 0 时，仍可能出现数值不稳定（虽有浓度下限，但对拟合敏感）
- [ ] 极端参数（如 `k0` 很大）会导致 `solve_ivp` 难收敛或非常慢（尤其多起点时）
- [ ] 大数据集（>1000 行）拟合速度较慢（每次评估都会对每行积分）

## ✅ 已完成功能（对齐当前代码）

- [x] 基本 PFR 模型和 ODE 求解（`solve_ivp`）
- [x] Batch Reactor（间歇式反应器）模型（`solve_ivp`）
- [x] 幂律动力学 + Arrhenius 温度依赖
- [x] 多物种、多反应支持（自定义 ν、n）
- [x] 参数拟合开关（k₀、Eₐ、n；以及 L-H / 可逆相关参数）
- [x] 多种目标变量（Fout、Cout、X；Batch 禁用 Fout 并提示）
- [x] 多起点拟合（multi-start）与参数缩放、可调 `diff_step`、可调 `max_nfev`
- [x] 奇偶校验图（Parity Plot）与误差图
- [x] CSV 模板下载（可选生成测量列类型）
- [x] 教程/帮助页（快速上手/CSV 列说明/动力学模型/拟合技巧/常见问题）
- [x] 示例数据下载（PFR: `test_data/test_data_matched.csv`；Batch: App 内生成）
- [x] 导出拟合结果（参数 CSV、预测 vs 实验对比 CSV；L-H 额外导出吸附参数）
- [x] Langmuir-Hinshelwood 动力学（支持 K 与 m）
- [x] 可逆反应模型（正/逆反应独立参数）

## 🧊 已移除/暂缓（避免重复投入）

- [x] ~~残差分布直方图~~（已移除）
- [x] ~~置信区间估计（基于 Jacobian 的线性化）~~（已移除；建议改用 Bootstrap）

---

*最后更新：2025-12-18*
