# Kinetics_app 用户指南（详细版）

> 面向对象：化工/反应工程人员 + Python 初学者  
> 目标：**按步骤完成一次**“建模 → 导入数据 → 参数拟合 → 诊断 → 导出复现”

## 目录

- 1. 这个 App 能做什么
- 2. 安装与运行
- 3. 界面总览（3 个页面）
- 4. 从 0 跑通一次（推荐流程）
- 5. 反应模型输入：物种、反应数、$\nu$ 矩阵、级数、参数
- 6. CSV 数据格式：PFR / CSTR / BSTR（最容易出错）
- 7. 拟合设置：边界、求解器、Multi-start、diff_step
- 8. 结果解读：奇偶校验图、残差、剖面、导出
- 9. 常见问题（故障排查）
- 10. 缓存与配置：自动保存在哪里，如何清空

---

## 1. 这个 App 能做什么

Kinetics_app 是一个基于 **Streamlit** 的网页工具，用于：

- **PFR（平推流）**、**CSTR（连续搅拌釜）**与**BSTR（间歇搅拌釜）**反应器的动力学参数拟合与模拟
- 多物种、多反应（任意 $\nu$ 矩阵）
- 动力学模型：幂律（power-law）、Langmuir–Hinshelwood（L-H）、可逆反应（reversible）
- 拟合参数可选择：$k_0$、$E_a$、反应级数 $n$；L-H 的 $K_0$、$E_{a,K}$、抑制指数 $m$；可逆的逆向参数

### 1.1 支持与不支持（重要）

- 支持：**PFR、CSTR、BSTR**
- 不支持：压降、体积流量沿程变化、气相非理想、能量方程（非等温沿程/随时间）
- PFR 默认假设：液相/恒定体积流量 $\dot{v}$，因此 $C_i = F_i/\dot{v}$

---

## 2. 安装与运行

### 2.1 环境要求

- Python **3.10+**（代码使用了 `X | None` 类型标注语法）
- 依赖见 `requirements.txt`

### 2.2 安装

```bash
pip install -r requirements.txt
```

### 2.3 运行

```bash
streamlit run app.py
```

默认打开：`http://localhost:8501`

---

## 3. 界面总览（3 个页面）

应用主界面分为：

1) **① 反应与模型**：设置反应器类型、动力学模型、物种、反应数、$\nu$ 矩阵、级数矩阵、参数初值与拟合开关  
2) **② 实验数据**：下载 CSV 模板、上传 CSV、选择拟合目标变量（Fout/Cout）与参与拟合的物种  
3) **③ 拟合与结果**：设置拟合高级选项与边界，开始拟合，查看图表与导出结果  

左侧侧边栏是“全局设置”（反应器/动力学/求解器）与“配置管理（导入/导出/重置）”。

---

## 4. 从 0 跑通一次（推荐流程）

### 4.1 第一次建议：先跑通示例数据

**Step 1：打开 App**

```bash
streamlit run app.py
```

**Step 2：点左侧 `📖 教程/帮助`，下载示例 CSV（PFR 或 BSTR）**

- PFR 示例：`test_data/orthogonal_design_data.csv`（也可运行 `python test_data/generate_orthogonal_design.py` 重新生成）
- CSTR/BSTR 示例：App 内自动生成（下载即可）

**Step 3：按示例配置输入模型**

- 物种：例如 `A,B`
- 反应数：`1`
- $\nu$：A 为 -1，B 为 +1
- 幂律：令 $n_A=1$，其他为 0
- $k_0,E_a$：填一个合理初值（不确定就先用示例默认）

**Step 4：到「② 实验数据」上传 CSV**

**Step 5：选择拟合目标变量与目标物种**

- PFR 示例通常选：`Fout (mol/s)`，目标物种选 `A`（示例文件仅提供 `Fout_A_mol_s`）
- BSTR 示例通常选：`Cout (mol/m^3)`

**Step 6：到「③ 拟合与结果」点 `🚀 开始拟合`**

如果卡住/报错，直接跳到第 9 节“常见问题”。

---

## 5. 反应模型输入（最核心）

### 5.1 物种名 `A,B,C,...`

- 用英文逗号分隔，例如：`A,B,C`
- 物种名会决定 CSV 列名：例如 `F0_A_mol_s`、`Cout_B_mol_m3`

### 5.2 反应数

设置反应条数 $N_{rxn}$，后续所有参数数组长度都按它生成：

- $k_0$、$E_a$：长度 = 反应数
- 抑制指数 $m$：长度 = 反应数
- 级数矩阵 $n$：形状 =（反应数 × 物种数）

### 5.3 化学计量数矩阵 $\nu$（行=物种，列=反应）

约定：

- 反应物：$\nu<0$
- 生成物：$\nu>0$

例：单反应 $A \rightarrow B$  

| 物种 \\ 反应 | R1 |
|---|---:|
| A | -1 |
| B | +1 |

例：串联 $A\rightarrow B\rightarrow C$（两步反应）

| 物种 \\ 反应 | R1 | R2 |
|---|---:|---:|
| A | -1 | 0 |
| B | +1 | -1 |
| C | 0 | +1 |

### 5.4 幂律模型（power-law）

对于第 $j$ 个反应：

$$r_j = k_j(T)\prod_i C_i^{n_{i,j}}$$

$$k_j(T)=k_{0,j}\exp\left(-\frac{E_{a,j}}{RT}\right)$$

- $n_{i,j}$ 在 App 里对应“反应级数 n”表格
- 若某物种不参与该反应，令其 $n=0$

### 5.5 L-H 模型（langmuir_hinshelwood）

$$r_j=\frac{k_j(T)\prod_i C_i^{n_{i,j}}}{\left(1+\sum_i K_i(T)C_i\right)^{m_j}}$$

$$K_i(T)=K_{0,i}\exp\left(-\frac{E_{a,K,i}}{RT}\right)$$

输入项：

- 幂律部分：$k_0,E_a,n$
- 吸附部分：每个物种一个 $K_{0,i}$ 与 $E_{a,K,i}$
- 抑制指数：每个反应一个 $m_j$

### 5.6 可逆模型（reversible）

$$r_j=k_j^+(T)\prod_i C_i^{n_{i,j}^+}-k_j^-(T)\prod_i C_i^{n_{i,j}^-}$$

App 中：

- 正反应：$k_0,E_a,n$
- 逆反应：$k_0^-,E_a^-,n^-$（在“可逆反应(逆反应)参数”里）

---

## 6. CSV 数据格式（最容易出错）

**核心原则：列名必须严格匹配模板**（大小写/下划线/单位后缀都要一致）。

### 6.1 一行数据代表什么？

- **PFR**：一行 = 一个实验工况（给定 $V,T,\dot{v}$ 与入口 $F_{0,i}$），测量是该工况下的出口  
- **CSTR**：一行 = 一个稳态工况（给定 $V,T,\dot{v}$ 与入口 $C_{0,i}$），测量是该工况下的出口（通常认为出口=釜内浓度）
- **BSTR**：一行 = 在同一组初始浓度 $C_{0,i}$ 与温度 $T$ 下，某个时间点 $t$ 的测量

### 6.2 PFR 必要输入列（每行都要有）

- `V_m3`：反应器体积 [m³]
- `T_K`：温度 [K]
- `vdot_m3_s`：体积流量 [m³/s]
- `F0_<物种名>_mol_s`：入口摩尔流量 [mol/s]（每个物种一列）

### 6.3 CSTR 必要输入列（每行都要有）

- `V_m3`：反应器体积 [m³]
- `T_K`：温度 [K]
- `vdot_m3_s`：体积流量 [m³/s]
- `C0_<物种名>_mol_m3`：入口浓度 [mol/m³]（每个物种一列）

### 6.4 BSTR 必要输入列（每行都要有）

- `t_s`：时间 [s]
- `T_K`：温度 [K]
- `C0_<物种名>_mol_m3`：初始浓度 [mol/m³]（每个物种一列）

### 6.5 测量列（按你选择的“拟合目标变量”决定）

两种测量口径（**只能选其一作为当前拟合的目标变量**）：

- `Fout_<物种名>_mol_s`：出口摩尔流量 [mol/s]（PFR / CSTR 可选；BSTR 不支持）
- `Cout_<物种名>_mol_m3`：出口浓度 [mol/m³]

### 6.6 重要限制：所选测量列不能有 NaN/空值

App 会对你“当前选中的目标变量 + 目标物种”对应的测量列做检查：

- 只要这些列里 **出现 NaN/空白/非数字**，拟合会直接停止并报错

因此：

- 如果某物种没有测量：请在“进入目标函数的物种”里**取消勾选该物种**  
- 如果某些实验行没有测量：建议**拆分数据文件**（只保留有测量的行），或先补齐数据再拟合

---

## 7. 拟合设置（让拟合更稳）

### 7.1 参数边界（强烈建议设置）

在「③ 拟合与结果」→“高级设置与边界”里设置：

- `k0 Min/Max`
- `Ea Min/Max`
- `Order Min/Max`

经验建议（先稳健，再追求精确）：

- 不确定时：先把边界设置得“合理但不离谱”，避免优化跑到物理不可能区间
- 如果出现 `x0 infeasible`（初值不在边界内）：App 会把初值裁剪到边界内，但更推荐你自己把初值/边界设得一致

### 7.2 ODE 求解器（RK45 / BDF / Radau）

数值积分使用 `scipy.integrate.solve_ivp`：

- `RK45`：非刚性问题常用，速度快
- `BDF`：刚性问题更稳（常见于快慢反应并存、级数较大、浓度跨数量级）
- `Radau`：刚性问题也很稳，但可能更慢

当你看到：

- “`solve_ivp失败` / 收敛很慢 / 参数一改就崩”  
优先尝试：把求解器切到 `BDF` 或 `Radau`

### 7.3 `max_step_fraction`（控制 ODE 步长）

App 将其转为 `solve_ivp(max_step=...)`：

$$\text{max\_step}=\text{max\_step\_fraction}\times(\text{总时间或总体积})$$

- 设为 `0`：不限制（使用 solve_ivp 默认）
- 反应很快、曲线变化很陡时：适当**减小**有时更稳（但更慢）

### 7.4 `diff_step`（数值差分步长，影响 Jacobian）

拟合使用 `scipy.optimize.least_squares` 的数值差分 Jacobian。  
当“初值不准导致拟合不动/抖动”时，常见改法：

- 把 `diff_step` 调大到 `1e-2 ~ 1e-3`（相对步长）

### 7.5 Multi-start（多起点）

如果你同时拟合很多参数（尤其包含 $E_a$ 与级数）：

- 建议勾选 `Multi-start`
- `Start Points` 设为 5~20

多起点会更慢，但更不容易陷入局部极小值。

---

## 8. 结果解读与导出

### 8.1 参数表

拟合完成后会展示：

- 最优参数（对应你勾选 `Fit_*` 的那些）
- 如果某些参数未勾选拟合，它们会保持为你输入的初值

### 8.2 奇偶校验图（Parity Plot）

目的：检查预测值与实验值是否接近 $y=x$。  
常见判断：

- 点整体靠近对角线：拟合较好
- 点呈系统偏差（整体偏上/偏下）：可能模型结构或测量口径不匹配

### 8.3 残差图

残差 $r = y^{pred}-y^{meas}$：

- 残差随工况（$T,V,t$）呈趋势：提示模型缺项（传质/热效应/副反应等）或数据系统误差
- 少数点残差极大：先排查数据录入/单位/列名

### 8.4 沿程/随时间剖面

剖面是**模型预测**（不是实验测量值）：

- PFR：沿体积 $V$ 的 $F_i(V)$、$C_i(V)$、$X_i(V)$
- BSTR：随时间 $t$ 的 $C_i(t)$、$X_i(t)$

### 8.5 导出

在「导出」页可导出：

- 参数 CSV（基础参数与/或全部参数）
- “预测 vs 实验”长表 CSV（便于你用 Excel/Origin 画图）
- 图像（PNG/SVG，适合报告/论文）

---

## 9. 常见问题（故障排查）

### 9.1 上传 CSV 后报“缺列/列名不匹配”

处理：

- 先用 App 的“下载模板”，把你的数据粘进去
- 物种名变更会改变列名：例如你把物种从 `A` 改成 `A1`，CSV 也要跟着改列名

### 9.2 报“测量列存在 NaN/非数字”

处理（两选一）：

- 清理 CSV：删除/填补缺失值，确保所选测量列每行都是数字
- 或在 App 中取消选择对应输出物种/输出模式

### 9.3 `solve_ivp失败` / 拟合很慢

优先尝试（从容易到更激进）：

1) 求解器换 `BDF` 或 `Radau`
2) 放宽 `rtol/atol`（例如 `rtol=1e-6~1e-4`，`atol=1e-9~1e-7`）
3) 调整 `max_step_fraction`（更小更稳但更慢；有时设 0 反而更快）
4) 缩紧参数边界、改进初值（避免参数导致极端速率）

### 9.4 拟合不收敛/卡在边界

常见原因与处理：

- 初值太差：先用更少参数拟合（只拟合 $k_0$ 或只拟合少数反应），再逐步放开
- 相关性强：$k_0$ 与 $E_a$ 可能高度相关，建议增加温度跨度或先固定其中一个
- 局部极小值：开启 Multi-start
- 数值差分太“敏感”：把 `diff_step` 调大

---

## 10. 缓存与配置（自动保存在哪里？如何清空？）

### 10.1 自动保存的内容

- 上传的 CSV：会在本机临时目录缓存一份（便于刷新页面后恢复）
- 配置 JSON：会自动保存“上一次配置”，下次打开自动恢复
- 在云端（如 Streamlit Cloud）：会额外保存到浏览器 LocalStorage

### 10.2 如何清空

- 清空上传 CSV：在「② 实验数据」点 `🗑️ 删除已上传文件`
- 清空配置：在侧边栏“配置管理”里重置/清除（或手动删除临时目录里的缓存文件）
