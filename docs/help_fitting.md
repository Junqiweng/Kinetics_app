# 拟合与数值设置（参考手册：每个旋钮怎么改、改了会怎样）

## 本页解决什么问题 / 适用场景

当你遇到以下问题时，优先看本页：

- 拟合能跑但不收敛/很慢/卡在边界/抖动
- `solve_ivp 失败`、对 `Method` 与 `rtol/atol` 不知道怎么调
- 想理解 `差分步长（diff_step）`、`多起点搜索（Multi-start）`、`启用雅可比尺度归一（x_scale='jac'）` 等高级设置的作用

本页所有字段名都与 App UI 完全一致，便于你**直接对照修改**。

---

## 目录（TOC）

- [A. 目标函数与残差类型（与 UI 一致）](#a-目标函数与残差类型与-ui-一致)
- [B. 参数边界：先设边界，再拟合](#b-参数边界先设边界再拟合)
- [C. 高级设置与边界：字段逐项说明](#c-高级设置与边界字段逐项说明)
- [D. 速查表：一眼找到该调哪个旋钮](#d-速查表一眼找到该调哪个旋钮)
- [E. 调参处方（10 个典型场景）](#e-调参处方10-个典型场景)
- [F. 常见错误 → 处理路径（按优先级）](#f-常见错误--处理路径按优先级)

---

## A. 目标函数与残差类型（与 UI 一致）

### A1. 目标函数（least_squares 在最小化什么？）

App 使用非线性最小二乘（`scipy.optimize.least_squares`）最小化：

$$\Phi(\theta)=\frac{1}{2}\sum_{i=1}^{N} r_i(\theta)^2$$

其中：

- $\theta$：你勾选了 `拟合 ...` 的参数集合（例如 `拟合 k₀`、`拟合 Eₐ`、`拟合 <物种>` 等）
- $r_i$：按你选择的“残差类型”构建的残差（见下）
- $N$：进入目标函数的数据点总数（= CSV 行数 × 目标物种数，按选择决定）

### A2. 残差类型（「③ 拟合与结果」→ `残差类型`）

UI 选项与公式：

- `绝对残差`
  - $$r_i = y_i^{pred} - y_i^{meas}$$
  - 适用：测量值数量级相近；缺点：大值更容易主导拟合
- `相对残差`
  - $$r_i = \frac{y_i^{pred} - y_i^{meas}}{\mathrm{sign}(y_i^{meas})\cdot\max(|y_i^{meas}|,\epsilon)}$$
  - 适用：测量值跨多个数量级；通过 $\epsilon$ 抑制 $y^{meas}\approx 0$ 的除零问题
- `百分比残差`
  - $$r_i = 100 \times \frac{y_i^{pred} - y_i^{meas}}{|y_i^{meas}| + \epsilon}$$
  - 其中 $\epsilon$ 为小正数，用于避免除零；该残差以 % 计，更适合需要直观百分比误差权重的场景

> 实务建议：当你发现相对残差导致拟合不稳（尤其有接近 0 的测量），优先切回 `绝对残差` 或 `百分比残差`，再谈其它调参。

---

## B. 参数边界：先设边界，再拟合

位置：`③ 拟合与结果` → 展开 `高级设置与边界 (点击展开)` → `1. 基础边界设置`

边界字段（UI 名称）：

- `k₀ Min`、`k₀ Max`
- `Eₐ Min`、`Eₐ Max`
- `Order Min`、`Order Max`

重要规则（必须理解）：

1) 边界**只作用于“勾选拟合”的参数**。未勾选拟合的参数不会进入优化向量，也不会被边界约束。
2) 任何被拟合的参数，**初值必须在边界内**，否则会出现 `x₀ infeasible`（初值越界）。
3) 边界越宽，越容易跑到“物理不合理/数值崩溃”的区域；边界越窄，越容易卡边界或无法解释数据。推荐策略：**先稳健（合理但不离谱）→ 再逐步收紧/放宽**。

默认边界（用于快速起步，建议按体系收紧）：

- `k₀ Min=1e-15`，`k₀ Max=1e15`
- `Eₐ Min=3e4`，`Eₐ Max=3e5`（J/mol）
- `Order Min=-2`，`Order Max=5`

> 说明：若你启用了“配置自动恢复”或导入过配置 JSON，这些字段的初始值可能会被覆盖；**以你当前界面显示为准**。

---

## C. 高级设置与边界：字段逐项说明

位置：`③ 拟合与结果` → `高级设置与边界 (点击展开)`

此外，ODE 求解器与容差在侧边栏：

- `Method`：`RK45 / BDF / Radau`
- `rtol`、`atol`

### C1. `1. 基础边界设置`（必用）

- `k₀ Min/Max`：约束所有被勾选 `拟合 k₀` 的反应指前因子
- `Eₐ Min/Max`：约束所有被勾选 `拟合 Eₐ` 的活化能
- `Order Min/Max`：约束所有被勾选 `拟合 <物种>` 的级数项

调参方向：

- 若提示 `x₀ infeasible`：放宽边界或把初值改到边界内（更推荐改初值）
- 若拟合跑到极端值、`solve_ivp 失败` 频繁：收紧边界
- 若明显拟合不了数据趋势：适度放宽边界，或先减少拟合参数数量

### C2. `1.2 L-H 边界设置`（仅当动力学为 `langmuir_hinshelwood`）

UI 字段：

- `K0_ads Min/Max`（默认 `0` 到 `1e10`）
- `Ea_K Min/Max`（默认 `-2e5` 到 `2e5`，J/mol）

建议：

- `K0_ads` 一般非负；先固定不拟合，再逐步放开
- `Ea_K` 允许负；若数据温度跨度小，建议先固定

### C3. `1.3 可逆反应边界设置（逆反应）`（仅当动力学为 `reversible`）

UI 字段：

- `k0_rev Min/Max`
- `Ea_rev Min/Max`
- `Order_rev Min/Max`

建议：

- 逆向参数建议最后再放开；先让正向拟合到数量级正确
- 一旦放开逆向，边界必须更谨慎（可逆系统更容易相关性强、局部极小值多）

### C4. `2. 算法与鲁棒性`（决定“稳不稳/快不快”）

#### (1) `最大迭代次数（max_nfev）`（UI：`最大迭代次数（max_nfev）`）

- 含义：`least_squares(max_nfev=...)` 的最大函数评估次数上限（外层迭代）
- 现象：
  - 太小：拟合提前停止（常见提示：达到最大迭代次数上限）
  - 太大：可能更慢，但不一定更好（若模型不可辨识/陷入局部极小值，单纯加迭代无效）

建议：

- 先用默认（常为 `3000`）跑通，再根据“是否提前停止”决定是否增大

#### (2) `差分步长（diff_step）`（数值差分步长）

- 含义：用于数值差分 Jacobian 的**相对步长**
- 现象与对策：
  - 拟合“不动/抖动/对噪声极敏感”：把 `差分步长（diff_step）` 调大（例如 `1e-3 → 1e-2`）
  - 拟合能动但精度不够：在稳定前提下再逐步调小

> 默认值常为 `1e-3`。新手遇到不稳时，优先尝试 `1e-2 ~ 1e-3`。

#### (3) `最大步长比例（max_step_fraction）`（限制 ODE 积分步长）

- 含义：用于 `solve_ivp(max_step=...)` 的步长限制
- App 使用的换算形式（直观理解）：

$$\text{max\_step}=\text{max\_step\_fraction}\times(\text{总时间或总体积})$$

- 取值解释：
  - 设为 `0`：不限制（使用 `solve_ivp` 默认策略）
  - 设为更小：更稳健，但更慢（尤其在速率很快、曲线很陡时）

调参优先级：

1) `solve_ivp 失败` 频繁 → 先尝试减小 `最大步长比例（max_step_fraction）`
2) 若仍失败 → 再考虑更换 `Method` 或放宽 `rtol/atol`

#### (4) `多起点搜索（Multi-start）`、`起点数量（n_starts）`、`粗拟合迭代上限（max_nfev_coarse）`

用途：当参数多、相关性强、容易陷入局部极小值时，提高找到更好解的概率。

- `多起点搜索（Multi-start）`：开/关
- `起点数量（n_starts）`：起点数量（推荐 `5~20`）
- `粗拟合迭代上限（max_nfev_coarse）`：每个起点的粗拟合迭代上限（常见默认 `300`）

工程理解：

- 多起点 = 更慢但更稳（尤其在放开 `Eₐ`、级数、L-H、可逆时）
- 如果多起点几乎不改善：优先检查边界是否过宽、初值是否离谱、模型是否缺项

#### (5) `启用雅可比尺度归一（x_scale='jac'）`

- 含义：对不同量纲/尺度的参数做缩放，提高优化稳定性
- 建议：多数情况下保持开启；若你确认缩放导致异常（少见），再尝试关闭作对照

#### (6) `随机种子（random_seed）`

- 作用：Multi-start 随机起点的可复现性
- 典型用法：想复现实验/报告时固定；想更广泛探索时可换不同 seed

---

## D. 速查表：一眼找到该调哪个旋钮

| 症状（你看到什么） | 优先改的旋钮（UI 名称） | 推荐动作（从高到低） |
|---|---|---|
| `solve_ivp 失败` / 参数一改就崩 | `Method`、`rtol/atol`、`最大步长比例（max_step_fraction）` | `Method→BDF`；放宽 `rtol/atol`；调小 `最大步长比例（max_step_fraction）` 或设 `0` 对比 |
| 拟合“不动”或抖动 | `差分步长（diff_step）`、拟合参数数量 | `差分步长（diff_step）` 调大到 `1e-2~1e-3`；减少拟合参数（先只拟合 `k₀`） |
| 拟合很慢 | `起点数量（n_starts）`、`粗拟合迭代上限（max_nfev_coarse）`、数据量 | 先关 `Multi-start`；先用少量数据跑通；再逐步加回 |
| 参数卡在边界 | `k₀/Eₐ/Order Min/Max` | 放宽边界或改初值；更推荐先减少拟合参数、分阶段放开 |
| 相对残差“炸” | `残差类型` | 切回 `绝对残差` 或 `百分比残差`，再检查测量列是否接近 0 |
| 多起点没改善 | 边界/初值/模型结构 | 收紧边界；改合理初值；分阶段拟合；必要时换模型（如加 L-H/可逆） |

---

## E. 调参处方（10 个典型场景）

> 说明：每条处方都给出“第一优先级操作”（通常 1–3 步），先做这些再做更激进操作。

1) **场景：`x₀ infeasible`（初值越界）**

- 先做：把「①」的初值改到 `k₀ Min/Max`、`Eₐ Min/Max`、`Order Min/Max` 内
- 再做：必要时放宽边界（但不建议无限放宽）

2) **场景：拟合一开始就失败（提示 NaN/非有限）**

- 先做：检查 `k₀`、`Eₐ [J/mol]` 表是否有空白/文本（会变 `NaN`）
- 再做：用 `1e6` 这类纯数字重填；先取消勾选拟合验证模型可算

3) **场景：`solve_ivp 失败`**

- 先做：侧边栏 `Method→BDF`；放宽 `rtol/atol`
- 再做：`最大步长比例（max_step_fraction）` 调小；收紧边界避免极端参数
- 再检查：PFR 时 `PFR 流动模型` 与 CSV 是否匹配（液相 `vdot_m3_s` / 气相 `P_Pa`）

4) **场景：拟合“不动”**

- 先做：只拟合 `k₀`（取消 `拟合 Eₐ` 与所有 `拟合 <物种>`）
- 再做：`差分步长（diff_step）` 调大

5) **场景：拟合抖动（参数/目标函数来回跳）**

- 先做：`差分步长（diff_step）` 调大；收紧边界
- 再做：开启 `多起点搜索（Multi-start）`（`Start Points=10` 起步）

6) **场景：参数卡边界**

- 先做：检查边界是否过窄/初值是否贴边；改初值到区间中部
- 再做：适度放宽边界，但同步检查物理合理性

7) **场景：相对残差导致不稳定**

- 先做：`残差类型→绝对残差` 或 `百分比残差`
- 再做：检查测量列是否存在接近 0 的点/单位是否错误

8) **场景：多起点非常慢**

- 先做：减少 `起点数量（n_starts）`（例如 20→10→5）
- 再做：降低 `粗拟合迭代上限（max_nfev_coarse）`；先用少量数据跑通

9) **场景：增加迭代次数无效**

- 先做：减少拟合参数数量（分阶段放开）
- 再做：收紧边界、改更合理初值；必要时换残差类型/模型结构

10) **场景：`k₀` 与 `Eₐ` 高相关，结果不唯一**

- 先做：增加温度跨度（实验设计层面）或先固定 `Eₐ`
- 再做：在现有数据下，只拟合 `k₀`，把 `Eₐ` 作为先验固定值

---

## F. 常见错误 → 处理路径（按优先级）

### F1. 看到“达到最大迭代次数上限”

1) 确认是否因为拟合参数太多：先减少（只拟合 `k₀`）
2) 再增大 `最大迭代次数（max_nfev）`
3) 若仍无效：检查边界/初值/模型结构，不要盲目加迭代

### F2. 看到“所有实验点都无法成功预测”

1) 优先解决数值求解：`Method→BDF`、放宽 `rtol/atol`
2) 调整 `最大步长比例（max_step_fraction）`（减小或设 `0` 对比）
3) 若为 PFR：检查 `PFR 流动模型` 与输入列匹配（液相用 `vdot_m3_s`，气相用 `P_Pa`）
4) 收紧边界，避免优化跑到极端参数区

