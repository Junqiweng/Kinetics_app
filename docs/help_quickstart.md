# 快速上手（参考手册级：参数怎么改、改哪里、为什么这么改）

## 本页解决什么问题 / 适用场景

当你第一次使用 Kinetics_app，或遇到“跑不通/报错/拟合不动”时，本页提供**可照抄的最小流程**与**参数修改导航**，重点回答：

- 参数到底在 UI 的哪里改（初值 / 拟合勾选 / 边界 / 数值算法）
- 新手应该先拟合哪些参数、为什么要分阶段放开
- 表格如何正确输入（科学计数、批量粘贴、避免 NaN）

> 建议：先用示例 CSV 跑通一次，再替换为真实数据；能快速排除 80% 的“列名/单位/边界/初值”问题。  
> 说明：PFR 示例 `test_data/orthogonal_design_data.csv` 属于脚本产物，若本地不存在请先运行 `python test_data/generate_orthogonal_design.py`。

---

## 目录（TOC）

- [0. 一分钟总览（最小可行流程）](#0-一分钟总览最小可行流程)
- [1. 参数到底在哪里改？（UI 导航）](#1-参数到底在哪里改ui-导航)
- [2. 分阶段放开参数：新手最稳的拟合顺序](#2-分阶段放开参数新手最稳的拟合顺序)
- [3. 表格怎么编辑（科学计数/批量粘贴/避免 NaN）](#3-表格怎么编辑科学计数批量粘贴避免-nan)
- [4. 三个必查一致性（物种名/单位/边界↔初值）](#4-三个必查一致性物种名单位边界初值)
- [5. 速查表：常用参数在哪里改](#5-速查表常用参数在哪里改)
- [6. 常见错误 → 处理路径（按优先级）](#6-常见错误--处理路径按优先级)

---

## 0. 一分钟总览（最小可行流程）

你只需要按顺序完成 3 页操作即可跑通：

1) **建模：① 反应与模型**

- 设定 `物种列表 (逗号分隔)`、`反应数`
- 编辑 `化学计量数矩阵 ν (行=物种, 列=反应)`
- 输入参数初值（`k₀`、`Eₐ [J/mol]`、`n_<物种>` 等）并勾选要拟合的参数（`拟合 k₀`、`拟合 Eₐ`、`拟合 <物种>`）

2) **数据：② 实验数据**

- 上传 CSV（或下载 `CSV 模板` 后填入）
- 选择 `拟合目标变量` 与“进入目标函数的物种”（即输出物种）
- 若为 PFR，先确认侧边栏 `PFR 流动模型` 与 CSV 输入列匹配（液相 `vdot_m3_s` / 气相 `P_Pa`）

3) **拟合：③ 拟合与结果**

- 展开 `高级设置与边界 (点击展开)`，先设置边界（`k₀ Min/Max`、`Eₐ Min/Max`、`Order Min/Max` …）
- 点击 `🚀 开始拟合`

做到以下任意一点，即算“跑通”：

- 拟合完成并显示 `拟合结果`（参数表 + 奇偶校验图/残差图）
- 或至少能正常计算并绘制预测剖面（即使暂时不拟合，也能检查模型是否可算）

---

## 1. 参数到底在哪里改？（UI 导航）

### 1.1 侧边栏（全局设置）

- `反应器`：`PFR / CSTR / BSTR`
- `PFR 流动模型`（仅 PFR 显示）：`液相(恒定 vdot)` / `气相(理想气体、等温、恒压)`
- `动力学`：`power_law / langmuir_hinshelwood / reversible`
- `Method`（ODE 求解器）：`RK45 / BDF / Radau`
- `rtol`、`atol`：ODE 积分容差（影响能否算出来 + 速度）
- `⚙️ 配置管理 (导入/导出/重置)`：本次文档范围不展开（如需也可扩写到用户指南）

### 1.2 「① 反应与模型」（模型结构 + 初值 + 勾选拟合）

你会在该页依次看到：

- `化学计量数矩阵 ν`：决定每个反应对各物种的生成/消耗
- 参数初值：
  - `k₀` 与 `Eₐ [J/mol]`（按反应：R1、R2…）
  - `反应级数 n`（矩阵：行=反应，列=物种）
  - 若动力学为 `langmuir_hinshelwood`：`K₀,ads`、`Eₐ,K [J/mol]`（按物种）与 `m`（按反应）
  - 若动力学为 `reversible`：逆反应 `k₀⁻`、`Eₐ⁻ [J/mol]` 与逆反应级数 `n⁻`

> 关键：**是否参与拟合**由复选框决定（例如 `拟合 k₀`、`拟合 Eₐ`、`拟合 <物种>`）。未勾选的参数会保持为你输入的初值。

### 1.3 「③ 拟合与结果」→ `高级设置与边界 (点击展开)`

这是“拟合能否稳定、能否收敛”的关键区：

- 参数边界（强烈建议先设）：
  - `k₀ Min / k₀ Max`
  - `Eₐ Min / Eₐ Max`
  - `Order Min / Order Max`
  - （仅 L-H）`K0_ads Min/Max`、`Ea_K Min/Max`
  - （仅可逆）`k0_rev Min/Max`、`Ea_rev Min/Max`、`Order_rev Min/Max`
- 算法与鲁棒性：
  - `最大迭代次数（max_nfev）`、`差分步长（diff_step）`、`最大步长比例（max_step_fraction）`
  - `多起点搜索（Multi-start）`、`起点数量（n_starts）`、`粗拟合迭代上限（max_nfev_coarse）`
  - `启用雅可比尺度归一（x_scale='jac'）`、`随机种子（random_seed）`

---

## 2. 分阶段放开参数：新手最稳的拟合顺序

### 2.1 推荐顺序（适用于绝大多数数据）

按照“先数量级、再温度敏感性、最后结构自由度”的原则：

1) **第 1 次：只拟合 `k₀`**

- 在「① 反应与模型」→ `k₀ / Eₐ` 表：
  - 勾选所有反应的 `拟合 k₀`
  - 取消勾选所有反应的 `拟合 Eₐ`
- 在 `反应级数 n` 表：
  - 取消勾选所有 `拟合 <物种>`（先不让级数自由变化）

2) **第 2 次：在第 1 次基础上，再拟合 `Eₐ`**

- 继续勾选 `拟合 k₀`
- 勾选 `拟合 Eₐ`（前提：你的数据在温度上有足够跨度，否则 $E_a$ 往往不可辨识）

3) **第 3 次：最后再放开少量关键级数 `n`**

- 仅对“确定参与该反应”的少数物种勾选 `拟合 <物种>`
- 不参与的物种：设 `n=0` 且不要勾选拟合

### 2.2 对 L-H / 可逆模型的建议

- `langmuir_hinshelwood`：先把幂律部分（`k₀/Eₐ/n`）跑稳，再逐步放开 `K₀,ads`、`Eₐ,K`、`m`
- `reversible`：先只拟合正向，再逐步放开逆向 `k₀⁻/Eₐ⁻/n⁻`

---

## 3. 表格怎么编辑（科学计数/批量粘贴/避免 NaN）

### 3.1 科学计数输入规则（推荐）

以下写法**都推荐**（可直接粘贴）：

- `1e6`、`3.2e-4`、`8.0e4`

以下写法**容易导致非数字**（最终变成 NaN）：

- `1,000`（千分位逗号）
- `<0.1`（带符号/文本）
- `0.1 `（尾随不可见空格通常没事，但建议清理）

> 重要：`k₀`、`Eₐ [J/mol]` 等列在 UI 中是**文本列**；系统会在后台用“转数值”规则解析。凡是解析失败的单元格会变成 `NaN`，从而导致拟合失败或计算异常。

### 3.2 批量粘贴技巧

- 复制 Excel 的一列 → 在表格中点击第一格 → 直接粘贴（保持列对齐）
- 尽量不要粘贴包含空白行/合并单元格的区域
- 若你需要“固定某参数不拟合”：取消该列对应的 `拟合 ...` 复选框即可

### 3.3 避免 NaN 的最稳方法

- 表格中不要留空（空白会变 `NaN`）
- 对暂时未知的参数：用“合理数量级”的占位值（例如 `k₀=1e3`，`Eₐ=8e4`），并先不要勾选拟合

---

## 4. 三个必查一致性（物种名/单位/边界↔初值）

### 4.1 物种名 ↔ CSV 列名一致

物种名来自「① 反应与模型」的 `物种列表 (逗号分隔)`，它会决定 CSV 列名模板，例如：

- 物种 `A`：
  - PFR 入口：`F0_A_mol_s`
  - CSTR/BSTR 入口：`C0_A_mol_m3`
  - 输出浓度：`Cout_A_mol_m3`
  - 输出流量：`Fout_A_mol_s`（仅 PFR/CSTR）

### 4.2 单位体系一致（不要“列名写 SI，但数据填了非 SI”）

- $T$ 用 `T_K`（K）
- PFR（液相）：`V_m3`（m³）、`vdot_m3_s`（m³/s）
- PFR（气相）：`V_m3`（m³）、`P_Pa`（Pa）
- CSTR：`V_m3`（m³）、`vdot_m3_s`（m³/s）
- BSTR：`t_s`（s）
- 浓度 `*_mol_m3`（mol/m³），流量 `*_mol_s`（mol/s）

### 4.3 边界 ↔ 初值一致（避免 `x₀ infeasible`）

在「③ 拟合与结果」→ `高级设置与边界` 中设置的 `k₀ Min/Max`、`Eₐ Min/Max`、`Order Min/Max` 只对**勾选拟合**的参数生效。

最稳的规则：

- 若勾选了 `拟合 k₀`，则表格里的对应 `k₀` 初值必须满足：`k₀ Min ≤ k₀ ≤ k₀ Max`
- 若勾选了 `拟合 Eₐ`，则 `Eₐ Min ≤ Eₐ ≤ Eₐ Max`
- 若勾选了某物种的 `拟合 <物种>`（级数），则 `Order Min ≤ n ≤ Order Max`

---

## 5. 速查表：常用参数在哪里改

| 你要改什么 | UI 字段名（必须一致） | 在哪里改 | 单位/备注 |
|---|---|---|---|
| 反应器类型 | `反应器` | 侧边栏 | `PFR/CSTR/BSTR` |
| 动力学模型 | `动力学` | 侧边栏 | `power_law / langmuir_hinshelwood / reversible` |
| 求解器 | `Method` | 侧边栏 | `RK45/BDF/Radau` |
| ODE 容差 | `rtol`、`atol` | 侧边栏 | 越小越精细但可能更慢/更易失败 |
| 正向 `k₀/Eₐ` 初值 + 拟合勾选 | `k₀`、`Eₐ [J/mol]`、`拟合 k₀`、`拟合 Eₐ` | 「① 反应与模型」 | `Eₐ` 单位 J/mol |
| 级数矩阵 `n` + 拟合勾选 | `n_<物种>`、`拟合 <物种>` | 「① 反应与模型」 | 行=反应，列=物种 |
| 参数边界 | `k₀ Min/Max`、`Eₐ Min/Max`、`Order Min/Max` | 「③ 拟合与结果」→ `高级设置与边界` | 强烈建议先设 |
| 数值差分步长 | `差分步长（diff_step）` | 「③ 拟合与结果」→ `高级设置与边界` | 相对步长；拟合抖动/不动常调它 |
| ODE 步长限制 | `最大步长比例（max_step_fraction）` | 「③ 拟合与结果」→ `高级设置与边界` | `0` 表示不限制 |
| 多起点 | `多起点搜索（Multi-start）`、`起点数量（n_starts）` | 「③ 拟合与结果」→ `高级设置与边界` | 参数多/易局部极小值时开启 |

---

## 6. 常见错误 → 处理路径（按优先级）

### 6.1 提示“缺少必要输入列 / 缺少所选输出测量列”

优先级从高到低：

1) 在「② 实验数据」重新下载 `CSV 模板`，直接在模板里填数据（最稳）
2) 检查物种名是否与列名一致（物种名改变会改变 `F0_/C0_/Cout_/Fout_/xout_` 的列名）
3) 检查 `拟合目标变量` 与“进入目标函数的物种”是否与你 CSV 的测量列匹配
4) 若为 PFR：检查侧边栏 `PFR 流动模型` 是否与 CSV 输入列匹配（液相用 `vdot_m3_s`，气相用 `P_Pa`）

### 6.2 提示“所选输出测量列中存在 NaN/非数字值”

优先级从高到低：

1) 清理 CSV：把 `1,000`、`<0.1`、空白等改成纯数字
2) 在 App 里取消勾选没有测量的目标物种（不让它进入目标函数）
3) 若只有部分实验行缺测：拆分 CSV，只保留有测量的行

### 6.3 `solve_ivp 失败` / “所有实验点都无法成功预测”

优先级从高到低：

1) 侧边栏把 `Method` 切到 `BDF`（或 `Radau`）
2) 放宽 `rtol/atol`（例如 `rtol: 1e-6 → 1e-5`；`atol: 1e-9 → 1e-8`）
3) 在「③」把 `最大步长比例（max_step_fraction）` 调小（例如 `0.1 → 0.05 → 0.01`），或直接设 `0`（不限制）对比一下
4) 收紧参数边界（避免优化跑到极端 `k₀/Eₐ/n`）

### 6.4 拟合“不动”/抖动/很慢

优先级从高到低：

1) 减少拟合参数：按[第 2 节](#2-分阶段放开参数新手最稳的拟合顺序)先只拟合 `k₀`
2) 把 `差分步长（diff_step）` 调大到 `1e-2 ~ 1e-3`
3) 开启 `多起点搜索（Multi-start）`，`起点数量（n_starts）` 设为 `5~20`
4) 数据量很大：先用少量代表性行跑通，再逐步加回全部数据

