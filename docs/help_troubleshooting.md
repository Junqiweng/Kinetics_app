# 常见问题（参考手册：按“症状 → 定位 → 处理顺序”快速解决）

## 本页解决什么问题 / 适用场景

当你看到报错、拟合失败或结果异常时，本页提供：

- 与 App 实际报错措辞尽量一致的“症状索引”
- 每个症状的**最可能原因**与**按优先级排列**的处理步骤
- 参数修改相关问题（初值/边界/NaN/卡边界/数值不稳）的明确操作路径

---

## 目录（TOC）

- [0. 症状速查（先从这里找）](#0-症状速查先从这里找)
- [A. CSV/数据相关](#a-csv数据相关)
- [B. 拟合/参数相关（本次重点）](#b-拟合参数相关本次重点)
- [C. 求解器/数值相关（ODE/CSTR 稳态）](#c-求解器数值相关odecstr-稳态)
- [D. 性能相关（为什么慢/卡顿）](#d-性能相关为什么慢卡顿)
- [E. 界面与缓存](#e-界面与缓存)

---

## 0. 症状速查（先从这里找）

| 你看到的症状/提示 | 优先去看 |
|---|---|
| “数据表缺少必要输入列…” | [A1](#a1-提示缺少必要输入列--缺少所选输出测量列) |
| “数据表缺少所选输出测量列…” | [A1](#a1-提示缺少必要输入列--缺少所选输出测量列) |
| “所选输出测量列中存在 NaN/非数字值…” | [A2](#a2-提示所选输出测量列中存在-nan非数字值) |
| “输入条件列存在 NaN/非数字/不合理值…” | [A3](#a3-提示输入条件列存在-nan非数字不合理值) |
| `x₀ infeasible`（初值越界） | [B1](#b1-x₀-infeasible初值越界) |
| 拟合一开始就失败（NaN/非有限/空白参数） | [B2](#b2-参数表输入为空非数字导致-nan) |
| 参数卡在边界/贴边 | [B3](#b3-参数卡在边界或贴边) |
| `solve_ivp 失败` / “所有实验点都无法成功预测” | [C1](#c1-solve_ivp-失败--所有实验点都无法成功预测) |
| 拟合“不动”/抖动/很慢 | [C2](#c2-拟合不动抖动很慢) |
| 很慢/卡顿/CPU 占用高 | [D1](#d1-为什么会慢最常见原因) |

---

## A. CSV/数据相关

### A1. 提示“缺少必要输入列 / 缺少所选输出测量列”

你通常会看到类似信息（与 App 一致）：

- “数据表缺少必要输入列，无法进行模型计算与拟合。”
- 或“数据表缺少所选输出测量列，无法构建残差并进行拟合。”

最常见原因：

- 表头拼写不一致（大小写/下划线/单位后缀）
- 物种名在 UI 里改了，但 CSV 仍旧用旧物种名（列名没同步）
- 选了 `拟合目标变量`/目标物种，但 CSV 不存在对应测量列（例如选 `Cout` 但只有 `Fout`）

处理（按优先级）：

1) 在「② 实验数据」重新下载 `CSV 模板`，用模板表头填数据（最稳）
2) 检查物种名是否一致：物种名决定列名（例如物种 `A` → `F0_A_mol_s` / `Cout_A_mol_m3`）
3) 检查 `拟合目标变量`：
   - PFR/CSTR：可选 `Fout (mol/s)` / `Cout (mol/m^3)` / `xout (mole fraction)`
   - BSTR：只能选 `Cout (mol/m^3)`
4) 检查目标物种勾选与测量列对应：你勾选了哪个物种，就必须有该物种的测量列
5) 若为 PFR：检查侧边栏 `PFR 流动模型` 与 CSV 输入列是否匹配
   - 液相：`V_m3, T_K, vdot_m3_s` + `F0_*`（或 `Cout` 模式下 `C0_*`）
   - 气相：`V_m3, T_K, P_Pa` + `F0_*`

### A2. 提示“所选输出测量列中存在 NaN/非数字值”

最常见原因：

- Excel 里存在空白、`1,000`、`<0.1`、文本、`Inf`
- 你勾选了某物种进入目标函数，但该物种的测量列并不完整（某些行缺测）

处理（按优先级）：

1) 清理 CSV：确保**你选中的测量列**每一行都是纯数字（不要千分位逗号、不要文本）
2) 如果某物种没有测量：在“进入目标函数的物种”里**取消勾选它**
3) 如果只有部分行缺测：拆分 CSV（只保留测量完整的行），或先补齐数据再拟合

### A3. 提示“输入条件列存在 NaN/非数字/不合理值”

App 会对输入列做数值与物理约束检查（典型要求）：

- `T_K` 必须 $>0$
- `vdot_m3_s`（PFR 液相/CSTR）必须 $>0$
- `P_Pa`（PFR 气相）必须 $>0$
- `V_m3`（PFR/CSTR）不能为负
- `t_s`（BSTR）不能为负
- 入口 `F0_*` / `C0_*` 不能为负

处理：

1) 按报错里给出的列名与示例行号定位并修正
2) 优先排查“单位填错但数值合法”的情况（例如 `vdot_m3_s` 实际填了 L/min）

---

## B. 拟合/参数相关（本次重点）

### B1. `x₀ infeasible`（初值越界）

含义：你勾选拟合的某些参数初值不在边界内（`k₀ Min/Max`、`Eₐ Min/Max`、`Order Min/Max` 等），导致优化器无法开始。

典型触发方式：

- 勾选了 `拟合 k₀`，但 `k₀` 初值不满足 `k₀ Min ≤ k₀ ≤ k₀ Max`
- 勾选了 `拟合 Eₐ`，但 `Eₐ [J/mol]` 初值越界
- 勾选了 `拟合 <物种>`（级数），但某个 `n_<物种>` 越界

处理（按优先级）：

1) 更推荐：回到「① 反应与模型」把初值改到边界内（把初值放到区间中部通常更稳）
2) 或在「③ 拟合与结果」→ `高级设置与边界` 放宽边界以包含初值
3) 再开始拟合

### B2. 参数表输入为空/非数字导致 NaN

原因：`k₀`、`Eₐ [J/mol]` 等列是文本输入，后台会将其解析为数值；解析失败的单元格会变为 `NaN`，随后出现：

- 拟合一开始就失败（“初值必须有限/包含 NaN”）
- 或计算结果异常/空白

处理（按优先级）：

1) 检查「①」`k₀ / Eₐ` 表是否存在空白、`1,000`、`<0.1`、文本
2) 用科学计数重填（例如 `1e6`、`8e4`）
3) 先取消勾选对应的 `拟合 ...`，确认模型能算，再逐步放开

### B3. 参数卡在边界或贴边

最常见原因：

- 边界过窄，真实最优值在边界外
- 初值贴边，优化器容易“沿边走”
- 模型不可辨识/参数相关性强（常见于同时拟合 `k₀` 与 `Eₐ`、以及大规模放开级数）

处理（按优先级）：

1) 把初值改到边界区间中部（比单纯放宽边界更有效）
2) 分阶段拟合：先只拟合 `k₀` → 再放开 `Eₐ` → 最后再放开少量级数
3) 适度放宽边界（但同步检查物理合理性）
4) 若仍贴边：考虑固定部分参数或引入更多温度/浓度跨度数据

---

## C. 求解器/数值相关（ODE/CSTR 稳态）

### C1. `solve_ivp 失败` / “所有实验点都无法成功预测”

常见原因：

- 刚性强（快慢时间尺度并存、级数过大、浓度跨数量级）
- 容差过严（`rtol/atol` 太小）
- 步长控制不合适（`最大步长比例（max_step_fraction）`）
- 参数边界太宽，优化跑到极端区域（导致速率极快/极慢）

处理（按优先级）：

1) 侧边栏把 `Method` 换成 `LSODA`（默认推荐，自动刚性检测）或 `BDF` / `Radau`
2) 放宽容差：把 `rtol/atol` 调大一档（例如 `rtol: 1e-6 → 1e-5`，`atol: 1e-9 → 1e-8`）
3) 在「③」把 `最大步长比例（max_step_fraction）` 调小（更稳但更慢），或设 `0`（不限制）做对比
4) 收紧参数边界、改更合理初值（避免极端 `k₀/Eₐ/n`）

### C2. 拟合“不动”/抖动/很慢

处理（按优先级）：

1) 分阶段拟合：先只拟合 `k₀`（取消 `拟合 Eₐ` 与所有 `拟合 <物种>`）
2) 把 `差分步长（diff_step）` 调大到 `1e-2 ~ 1e-3`
3) 开启 `多起点搜索（Multi-start）`（`起点数量（n_starts）` 设 `5~20`；`粗拟合迭代上限（max_nfev_coarse）` 用默认起步）
4) 收紧边界（避免局部极小值与数值崩溃区）
5) 数据量很大：先用少量代表性数据跑通，再逐步加回全部数据

---

## D. 性能相关（为什么慢/卡顿）

### D1. 为什么会慢（最常见原因）

每一次目标函数评估都会对 CSV 的每一行工况计算模型：

- PFR/BSTR：每行都需要一次 `solve_ivp`
- CSTR：每行还需要做稳态求解（非线性方程组）

因此耗时规模近似随以下因素增加：

- 数据行数 ↑
- 目标物种数 ↑（进入目标函数的物种勾选越多，残差维度越大）
- 拟合参数数 ↑（每次 Jacobian 数值差分需要更多模型调用）
- Multi-start 起点数 ↑

### D2. 最有效的加速策略（按优先级）

1) 先用少量数据行跑通流程（5–20 行即可）
2) 先少拟合参数（只拟合 `k₀`）
3) 暂时关闭 `多起点搜索（Multi-start）`
4) 稳定后再逐步加回数据与拟合参数

## E. 界面与缓存

### E1. “我改了配置，但页面还在显示上一次的结果”

拟合完成后结果会缓存，以保证图表/导出一致性。

解决：在「③ 拟合与结果」点 `🧹 清除结果`，然后重新拟合。

